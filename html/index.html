<!DOCTYPE html>
<html lang="en">
<head>
	<!-- Required meta tags -->
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<!-- <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous"> -->
	
	<title>Project</title>

	<!--Import Google Icon Font-->
	<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0-beta/css/materialize.min.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0-beta/css/materialize.min.css">

	<script
	src="https://code.jquery.com/jquery-3.3.1.min.js"
	integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
	crossorigin="anonymous"></script>
	<style>
	  /* Always set the map height explicitly to define the size of the div
	  * element that contains the map. */
	  html, body, #map {
	  	width: 100%;
	  	height: 100%;
	  	margin: 0;
	  	padding: 0;
	  }
	  .layer, .layer svg {position: absolute;}

	  .layer svg {
	  	width: 60px;
	  	height: 60px;
	  	padding-right: 100px;
	  	font: 10px sans-serif;
	  }
	  #price_range {
	  	width: 80%;
	  	
	  }
	  .tooltip {	
		      position: absolute;
		      text-align: center;
		      padding: 4px;
		      background: #fff;
		      border: 0px;
		      pointer-events: none;
		 }
	</style>
</head>

<body>
	<p>Welcome to AirBnB <i class="material-icons">home</i> picker!</p>
	<form action="#">
		<p>Choose your max price by sliding the dot. Current max price is: $<span id="price_display">50</span> per night</p>
		<p class="range-field">
			<input type="range" id="price_range" min="0" max="100" oninput="update_dataset(this.value);" onchange="update_dataset(this.value);"/>
		</p>
	</form>
	<div id="map" style="width:1240px;height:600px"></div>
	<script type="text/javascript">
		
		/*global $*/
		/*global d3*/
		/*global google*/
		var map;
		var bound;
		var heatmapData = [];
		var heatmap;
		const HOUSE_ICON_SIZE = 25;
		var MAX_PRICE_IN_DATA;
		var MIN_PRICE_IN_DATA;
		
		var stored_data;
		var dataset;
		var margin = {top: 20, right: 10, bottom: 20, left: 10};
		var width = 800 - margin.left - margin.right;
		var height = 600 - margin.top - margin.bottom;
		var overlay;
		var no_of_drawings;
		function update_dataset(rat){
			$("#price_display").text(rat);
			
			dataset = []
			for(var i = 0; i<stored_data.length;i++){
				if(stored_data[i].price <= rat)
					dataset.push(stored_data[i]);
			}
			// console.log("new val for slider",rat);
			overlay.draw();
		};
		function eqfeed_callback() {
	// d3.csv("https://firebasestorage.googleapis.com/v0/b/cse6242-1522962742858.appspot.com/o/crime_demo_100.csv?alt=media&token=c0a77a38-89ee-40e5-b222-0e6fd5e4b309",function(dataset){
		// d3.csv("https://firebasestorage.googleapis.com/v0/b/cse6242-1522962742858.appspot.com/o/crime_demo_10_000.csv?alt=media&token=3425db39-acb4-412c-8319-8504344c0173"
		d3.csv("https://raw.githubusercontent.com/ckwan48/CSE6242_Project/master/crime_data/crime_demo_10_000.csv"
			,function(dataset){

				heatmapData = [];
		// console.log(dataset)
		
		for (var i = 0; i < dataset.length; i++) {
			var lat =  +parseFloat(dataset[i]["Latitude"]);
			var long =  +parseFloat(dataset[i]["Longitude"]);
			var latLng = new google.maps.LatLng(lat, long);
			heatmapData.push(latLng);
		}
		heatmap = new google.maps.visualization.HeatmapLayer({
			data: heatmapData,
			map: map
		});
		
	})
	}
	function shuffle(array) {
		var currentIndex = array.length, temporaryValue, randomIndex;

	  // While there remain elements to shuffle...
	  while (0 !== currentIndex) {

		// Pick a remaining element...
		randomIndex = Math.floor(Math.random() * currentIndex);
		currentIndex -= 1;

		// And swap it with the current element.
		temporaryValue = array[currentIndex];
		array[currentIndex] = array[randomIndex];
		array[randomIndex] = temporaryValue;
	}

	return array;
}	
$( document ).ready(function() {
	console.log( "ready!" );


		// d3.csv("https://firebasestorage.googleapis.com/v0/b/cse6242-1522962742858.appspot.com/o/airbnb_demo.csv?alt=media&token=0f31451e-844e-4c76-88b7-adc0d90a8532", function(dataset) {
			// d3.csv("https://firebasestorage.googleapis.com/v0/b/cse6242-1522962742858.appspot.com/o/airbnb_demo_5k.csv?alt=media&token=4367e724-4d6c-439a-9df1-95e4dd4a4a16", function(_dataset) {
			d3.csv("https://raw.githubusercontent.com/ckwan48/CSE6242_Project/master/airbnb_data/airbnb_safety_demo.csv", function(_dataset) {
				dataset = _dataset;
				
				bound = new google.maps.LatLngBounds();
				dataset = shuffle(dataset);
				for(var data in dataset){
					dataset[data].latitude =  +parseFloat(dataset[data].latitude);
					dataset[data].longitude =  +parseFloat(dataset[data].longitude);
					dataset[data].price =  +parseFloat(dataset[data].price);
					dataset[data].id =  +parseInt(dataset[data].id);

					var long = +dataset[data].longitude;
					var lat = +dataset[data].latitude;
					// console.log(long + " " + lat);
					bound.extend(new google.maps.LatLng(lat,long));
					
				}
				function compare(a,b){
					if(a.price < b.price)
						return -1;
					return 1;
				}
				dataset.sort(compare);
				dataset = dataset.slice(dataset.length*0.1,dataset.length*0.9);
				
				// console.log(dataset)
				
				MAX_PRICE_IN_DATA = d3.max(dataset,d => d.price);
				MIN_PRICE_IN_DATA = d3.min(dataset,d => d.price);
				
				$("#price_range").attr("max",MAX_PRICE_IN_DATA + 1);
				$("#price_range").attr("min",MIN_PRICE_IN_DATA );
				
				stored_data = shuffle(dataset);
				
				

			// var priceScale = d3.scale.linear()
			// 					 .domain([0,d3.max(dataset, function(d) { return d.price; })])
			// 					 .range([0, 5]); 
			
			d3.selectAll('#map').attr('width',width - 200);
			
			map = new google.maps.Map(d3.select("#map").node(),{
				zoom: 1,
				center: new google.maps.LatLng(dataset[0].latitude, dataset[0].longitude),
				mapTypeId: "roadmap"
			});
			
			map.fitBounds(bound);
			
			// Create a <script> tag and set the USGS URL as the source.
			var script = document.createElement('script');

			eqfeed_callback()

			overlay = new google.maps.OverlayView();
			overlay.onAdd = function(){
				var layer = d3.select(this.getPanes().overlayMouseTarget).append("div")
				.attr("class","layer");

				overlay.draw = function(){
					var projection = this.getProjection();
					var padding = 10;

					no_of_drawings = parseInt((map.getZoom()/8.0)**11);
					// console.log(no_of_drawings);
					var data_in_range = []
					// shuffled_dataset = shuffle(dataset)
					if(no_of_drawings > dataset.length*0.9)
						no_of_drawings = dataset.length;
					var data_to_draw = dataset.slice(0, no_of_drawings);


					// layer.selectAll("svg").remove();
					// d3.selectAll(".tooltip").remove();
					$(".opacity").remove();
					var div = d3.select("body").append("div")	
 						.attr("class", "tooltip")				
						.style("opacity", 0);


					var marker = layer.selectAll("svg")
					.data(data_to_draw , function(d) { return d.id });

					marker.each(transform) ;//update existing markers
					var safety_stars = "";
					
					var new_svgs = marker.enter().append("svg")
								.on("mouseover", function(d) {		
            						div.transition()		
               						 .duration(200)		
               						 .style("opacity", .9);		
               					var full_stars = "";
               					for(var i=0;i<d.Safety;i++)
               						full_stars += "<i class='material-icons'>star</i>";
               					var empty_stars = "";
               					for(var i=0;i<5 - d.Safety;i++)
               						empty_stars += "<i class='material-icons'>star_border</i>";
               					
          							div.html("Name of House:" + d.name + "<br/>"  + "Price: $" + d.price + " per night<br/>Safety level: " + full_stars + empty_stars)	
               						 .style("left", (d3.event.pageX) + "px")		
               						 .style("top", (d3.event.pageY - 28) + "px");	
            							})
            		.on("mouseout", function(d) {		
           							div.transition()		
                					  .duration(100)		
                					  .style("opacity", 0);	
			        	}).each(transform)
								.attr("class","marker");
					
					
					
					new_svgs.append("image")
					.attr("xlink:href","https://image.flaticon.com/icons/svg/608/608671.svg")
					.attr("width", HOUSE_ICON_SIZE)
					.attr("height", HOUSE_ICON_SIZE)

					// new_svgs.append("text")
					// .attr("x", padding + 7)
					// .attr("y", padding)
					// .attr("dy", ".31em")
					// .style("fill","blue")
					// .style("stroke","blue")
					// .text(function(d) { return d.price; });

					marker.exit()
					.remove();
					
					// marker.append("text")
					// 	.attr("x",padding + 7)
					// 	.attr("y",padding)
					// 	.attr("dy",".31em")
					// 	.text(function(d){return d.price;})
						
					function transform(d){
						d = new google.maps.LatLng(+d.latitude,+d.longitude);
						d = projection.fromLatLngToDivPixel(d);
						return d3.select(this)
						.style("left",(d.x - padding) + "px")
						.style("top",(d.y - padding) + "px" );
					}

						// console.log(map.getZoom());
					};

				}
				overlay.setMap(map);

			});


		});
	</script>
	<div>Icons made by <a href="https://www.flaticon.com/authors/swifticons" title="Swifticons">Swifticons</a> from <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a> is licensed by <a href="http://creativecommons.org/licenses/by/3.0/" title="Creative Commons BY 3.0" target="_blank">CC 3.0 BY</a></div>

	<!-- <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script> -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0-beta/js/materialize.min.js"></script>
	<script src="https://d3js.org/d3.v3.min.js"></script>
	<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCDvdyxZpXuv02KqZIdErEBon5C7_Z8F2g&libraries=visualization"
	async defer></script>
	<!-- <script src="//cdn.bootcss.com/noUiSlider/8.5.1/nouislider.js"></script> -->

</body>
</html>