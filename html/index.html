<!DOCTYPE html>
<html lang="en">
<head>
	<!-- Required meta tags -->
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<!-- <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous"> -->
	
	<title>Project</title>

	<!--Import Google Icon Font-->
	<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0-beta/css/materialize.min.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0-beta/css/materialize.min.css">

	<script
	src="https://code.jquery.com/jquery-3.3.1.min.js"
	integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
	crossorigin="anonymous"></script>
	<style>
	  /* Always set the map height explicitly to define the size of the div
	  * element that contains the map. */
	  html, body, #map {
	  	width: 100%;
	  	height: 100%;
	  	margin: 0;
	  	padding: 0;
	  }
	  .layer, .layer svg {position: absolute;}

	  .layer svg {
	  	width: 60px;
	  	height: 60px;
	  	padding-right: 100px;
	  	font: 10px sans-serif;
	  }
	  #price_range {
	  	width: 80%;
	  	
	  }
	</style>
</head>

<body>
	<p>Hello <i class="material-icons">home</i> </p>
	<form action="#">
		<p class="range-field">
			Choose your max price by sliding the dot:
			<input type="range" id="price_range" min="0" max="100" oninput="update_dataset(this.value);" onchange="update_dataset(this.value);"/>
		</p>
	</form>
	<div id="map" style="width:800px;height:600px"></div>
	<script type="text/javascript">
		
		/*global $*/
		/*global d3*/
		/*global google*/
		var map;
		var bound;
		var heatmapData = []
		var heatmap;
		const HOUSE_ICON_SIZE = 25;
		var MAX_PRICE_IN_DATA;
		var stored_data;
		var dataset;
		var margin = {top: 20, right: 10, bottom: 20, left: 10};
		var width = 800 - margin.left - margin.right;
		var height = 600 - margin.top - margin.bottom;
		var overlay;

		function update_dataset(rat){
			var rat = rat/100.0;
			dataset = stored_data.slice(0,stored_data.length*rat);
			// console.log("new val for slider",rat);
			overlay.draw();
		};
		function eqfeed_callback() {
	// d3.csv("https://firebasestorage.googleapis.com/v0/b/cse6242-1522962742858.appspot.com/o/crime_demo_100.csv?alt=media&token=c0a77a38-89ee-40e5-b222-0e6fd5e4b309",function(dataset){
		d3.csv("https://firebasestorage.googleapis.com/v0/b/cse6242-1522962742858.appspot.com/o/crime_demo_10_000.csv?alt=media&token=3425db39-acb4-412c-8319-8504344c0173"
			,function(dataset){

				heatmapData = [];
		// console.log(dataset)
		
		for (var i = 0; i < dataset.length; i++) {
			var lat =  +parseFloat(dataset[i]["Latitude"]);
			var long =  +parseFloat(dataset[i]["Longitude"]);
			var latLng = new google.maps.LatLng(lat, long);
			heatmapData.push(latLng);
		}
		heatmap = new google.maps.visualization.HeatmapLayer({
			data: heatmapData,
			map: map
		});
		
	})
	}
	function shuffle(array) {
		var currentIndex = array.length, temporaryValue, randomIndex;

	  // While there remain elements to shuffle...
	  while (0 !== currentIndex) {

		// Pick a remaining element...
		randomIndex = Math.floor(Math.random() * currentIndex);
		currentIndex -= 1;

		// And swap it with the current element.
		temporaryValue = array[currentIndex];
		array[currentIndex] = array[randomIndex];
		array[randomIndex] = temporaryValue;
	}

	return array;
}	
$( document ).ready(function() {
	console.log( "ready!" );


		// d3.csv("https://firebasestorage.googleapis.com/v0/b/cse6242-1522962742858.appspot.com/o/airbnb_demo.csv?alt=media&token=0f31451e-844e-4c76-88b7-adc0d90a8532", function(dataset) {
			d3.csv("https://firebasestorage.googleapis.com/v0/b/cse6242-1522962742858.appspot.com/o/airbnb_demo_5k.csv?alt=media&token=402360f2-a868-46dc-9c17-f429b19b92f3", function(_dataset) {
				dataset = _dataset;
				
				bound = new google.maps.LatLngBounds();
				dataset = shuffle(dataset);
				for(var data in dataset){
					dataset[data].latitude =  +parseFloat(dataset[data].latitude);
					dataset[data].longitude =  +parseFloat(dataset[data].longitude);

					var long = +dataset[data].longitude;
					var lat = +dataset[data].latitude;
					// console.log(long + " " + lat);
					bound.extend(new google.maps.LatLng(lat,long));
					
				}
				MAX_PRICE_IN_DATA = d3.max(dataset,d => d.price);
				stored_data = dataset;
				

			// var priceScale = d3.scale.linear()
			// 					 .domain([0,d3.max(dataset, function(d) { return d.price; })])
			// 					 .range([0, 5]); 
			
			d3.selectAll('#map').attr('width',width - 200);
			
			map = new google.maps.Map(d3.select("#map").node(),{
				zoom: 1,
				center: new google.maps.LatLng(dataset[0].latitude, dataset[0].longitude),
				mapTypeId: "roadmap"
			});
			
			map.fitBounds(bound);
			
			// Create a <script> tag and set the USGS URL as the source.
			var script = document.createElement('script');

			eqfeed_callback()

			overlay = new google.maps.OverlayView();
			overlay.onAdd = function(){
				var layer = d3.select(this.getPanes().overlayMouseTarget).append("div")
				.attr("class","layer");

				overlay.draw = function(){
					var projection = this.getProjection();
					var padding = 10;

					var no_of_drawings = parseInt((map.getZoom()/5)**5);
					// console.log(no_of_drawings);
					data_in_range = []
					for(var data in dataset){
						dataset[data].price
					}
					var data_to_draw = dataset.slice(0, no_of_drawings);


					// layer.selectAll("svg").remove();

					var marker = layer.selectAll("svg")
					.data(data_to_draw , function(d) { return d.id });

					marker.each(transform) ;//update existing markers
					new_svgs = marker.enter().append("svg")
					.each(transform)
					.attr("class","marker");
					// <i class="material-icons">home</i>
					new_svgs.append("image")
					.attr("xlink:href","https://image.flaticon.com/icons/svg/608/608671.svg")
					.attr("width", HOUSE_ICON_SIZE)
					.attr("height", HOUSE_ICON_SIZE)

					// new_svgs.append("text")
					// .attr("x", padding + 7)
					// .attr("y", padding)
					// .attr("dy", ".31em")
					// .style("fill","blue")
					// .style("stroke","blue")
					// .text(function(d) { return d.price; });

					marker.exit()
					.remove();

					function transform(d){
						d = new google.maps.LatLng(+d.latitude,+d.longitude);
						d = projection.fromLatLngToDivPixel(d);
						return d3.select(this)
						.style("left",(d.x - padding) + "px")
						.style("top",(d.y - padding) + "px" );
					}

						// console.log(map.getZoom());
					};

				}
				overlay.setMap(map);

			});


		});
	</script>
	<div>Icons made by <a href="https://www.flaticon.com/authors/swifticons" title="Swifticons">Swifticons</a> from <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a> is licensed by <a href="http://creativecommons.org/licenses/by/3.0/" title="Creative Commons BY 3.0" target="_blank">CC 3.0 BY</a></div>

	<!-- <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script> -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0-beta/js/materialize.min.js"></script>
	<script src="https://d3js.org/d3.v3.min.js"></script>
	<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCDvdyxZpXuv02KqZIdErEBon5C7_Z8F2g&libraries=visualization"
	async defer></script>
	<!-- <script src="//cdn.bootcss.com/noUiSlider/8.5.1/nouislider.js"></script> -->

</body>
</html>